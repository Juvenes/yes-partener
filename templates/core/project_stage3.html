<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>{{ project.name }} — Phase 3 : Coûts & Optimisation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #f5f7fb; margin: 2rem; }
    a { color: #0d47a1; }
    h1 { margin-bottom: .4rem; }
    h2 { margin-top: 2.2rem; }
    .btn { display: inline-flex; align-items: center; justify-content: center; padding: .65rem 1.1rem; border-radius: 10px; border: none; background: #0d47a1; color: #fff; font-weight: 600; cursor: pointer; text-decoration: none; }
    .btn-secondary { background: #263238; }
    .btn-small { padding: .45rem .85rem; font-size: .9rem; border-radius: 8px; }
    .grid { display: grid; gap: 1rem; }
    .card { background: #fff; border-radius: 14px; padding: 1.35rem; box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08); }
    .summary-grid { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .member-grid { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); margin-top: 1rem; }
    .muted { color: #5f6368; font-size: .95rem; }
    .messages { list-style: none; margin: 1rem 0; padding: 0; }
    .messages li { padding: .9rem 1rem; border-radius: 10px; margin-bottom: .6rem; }
    .messages li.success { background: #e8f5e9; color: #1b5e20; }
    .messages li.error { background: #ffebee; color: #c62828; }
    .messages li.warning { background: #fff8e1; color: #ff8f00; }
    table { width: 100%; border-collapse: collapse; margin-top: .35rem; }
    th, td { padding: .45rem .35rem; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: .92rem; }
    th { color: #37474f; font-weight: 600; }
    .pill { display: inline-flex; align-items: center; padding: .25rem .6rem; border-radius: 999px; background: #e3f2fd; color: #0d47a1; font-size: .8rem; font-weight: 700; }
    .kpi { font-size: 1.8rem; font-weight: 800; margin: .2rem 0; }
    .form-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: .6rem; }
    label { font-size: .9rem; color: #3949ab; display: flex; flex-direction: column; }
    input, select { margin-top: .3rem; padding: .55rem .6rem; border: 1px solid #cfd8dc; border-radius: 8px; font-size: .95rem; }
    .badge { display: inline-flex; align-items: center; padding: .2rem .5rem; border-radius: 8px; background: #eceff1; font-size: .8rem; font-weight: 600; }
  </style>
</head>
<body>
  <div class="breadcrumbs">
    <a href="{% url 'project_list' %}">Projets</a> · <a href="{% url 'project_detail' project.id %}">{{ project.name }}</a> · Phase 3
  </div>
  <div class="header" style="display:flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
      <h1>{{ project.name }} — Phase 3 : Coûts & Optimisation</h1>
      <p class="muted">Décomposez les tarifs par membre, calculez leur facture de référence et optimisez un prix communautaire unique.</p>
    </div>
    <div style="display:flex; gap:.5rem; flex-wrap: wrap;">
      <a class="btn-secondary btn" href="{% url 'project_detail' project.id %}">Retour phase 1</a>
      <a class="btn" href="{% url 'project_stage2' project.id %}">Phase 2</a>
    </div>
  </div>

  {% if messages %}
    <ul class="messages">
      {% for message in messages %}<li class="{{ message.tags }}">{{ message }}</li>{% endfor %}
    </ul>
  {% endif %}

  {% if load_warnings %}
    <ul class="messages">
      {% for warn in load_warnings %}<li class="warning">{{ warn }}</li>{% endfor %}
    </ul>
  {% endif %}

  {% if not stage2_scenarios %}
    <ul class="messages">
      <li class="warning">Créez au moins un scénario en phase 2 pour calculer les coûts communautaires.</li>
    </ul>
  {% else %}
    <form method="get" class="card" style="margin-top:1rem;">
      <h2>Étape suivante : choisir le scénario de partage (phase 2)</h2>
      <p class="muted">La phase 3 calcule les prix d'achat/vente sur l'énergie réellement partagée en phase 2. Ajustez la phase 2 puis cliquez sur «&nbsp;Utiliser ce scénario&nbsp;».</p>
      <div style="display:flex; gap:.75rem; align-items:flex-end; flex-wrap:wrap;">
        <label style="display:flex; flex-direction:column; gap:.35rem; font-size:.95rem; color:#3949ab;">
          Scénario phase 2
          <select name="stage2" style="min-width:220px; padding:.55rem .6rem; border-radius:8px; border:1px solid #cfd8dc;">
            {% for scenario in stage2_scenarios %}
              <option value="{{ scenario.id }}" {% if selected_stage2 and scenario.id == selected_stage2.id %}selected{% endif %}>{{ scenario.name }}</option>
            {% endfor %}
          </select>
        </label>
        <button class="btn" type="submit">Utiliser ce scénario</button>
        <a class="btn-secondary btn" href="{% url 'project_stage2' project.id %}">Revenir à la phase 2</a>
      </div>
      {% if stage2_evaluation %}
        <div class="muted" style="margin-top:.6rem; display:flex; gap:1rem; flex-wrap:wrap;">
          <span class="badge">Énergie partagée : {{ stage2_evaluation.total_community_allocation_kwh|floatformat:0 }} kWh</span>
          <span class="badge">Production restante : {{ stage2_evaluation.total_remaining_production_kwh|floatformat:0 }} kWh</span>
          <span class="badge">Consommation non servie : {{ stage2_evaluation.total_unserved_consumption_kwh|floatformat:0 }} kWh</span>
        </div>
      {% endif %}
    </form>
  {% endif %}

  <section class="grid summary-grid">
    <div class="card">
      <p class="muted">Consommation cumulée</p>
      <div class="kpi">{{ total_consumption|floatformat:0 }} kWh</div>
      <p class="muted">D'après les séries temporelles normalisées.</p>
    </div>
    <div class="card">
      <p class="muted">Coût de référence (hors communauté)</p>
      <div class="kpi">{{ total_baseline_cost|floatformat:2 }} €</div>
      <p class="muted">Basé sur la structure tarifaire de chaque membre.</p>
    </div>
    <div class="card">
      <p class="muted">Prix moyen de référence</p>
      <div class="kpi">{{ avg_baseline_cost}} €/kWh</div>
      <p class="muted">Prix pondéré par la consommation totale.</p>
    </div>
    {% if optimisation_result and optimisation_result.optimal_price_eur_per_kwh %}
      <div class="card">
        <p class="muted">Prix communautaire optimal</p>
        <div class="kpi">{{ optimisation_result.optimal_price_eur_per_kwh|floatformat:3 }} €/kWh</div>
        <p class="muted">Intervalle testé : {{ optimisation_result.min_injection|floatformat:3 }} → {{ optimisation_result.max_supplier|floatformat:3 }} €/kWh.</p>
      </div>
    {% endif %}
  </section>

  <section class="card" style="margin-top:1.5rem;">
    <h2>Paramètres communauté</h2>
    <p class="muted">Définissez le communityFee, le type de communauté et, le cas échéant, les tarifs réseau réduits pour un site unique.</p>
    <form method="post" action="" class="form-grid" style="margin-top:.8rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: .8rem;">
      {% csrf_token %}
      {% if selected_stage2 %}
        <input type="hidden" name="stage2" value="{{ selected_stage2.id }}" />
      {% endif %}
      {% for field in optimisation_form %}
        <label>
          {{ field.label }}
          {{ field }}
          {% if field.help_text %}<span class="muted">{{ field.help_text }}</span>{% endif %}
          {% if field.errors %}<span class="error">{{ field.errors|striptags }}</span>{% endif %}
        </label>
      {% endfor %}
      <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end;">
        <button class="btn" type="submit" name="optimize" value="1">Optimiser le prix communautaire</button>
      </div>
    </form>
    {% if optimisation_result %}
      <div style="margin-top:1rem; display:flex; gap:1rem; flex-wrap:wrap;">
        <span class="pill">minInjection = {{ optimisation_result.min_injection|floatformat:3 }} €/kWh</span>
        <span class="pill">maxSupplier = {{ optimisation_result.max_supplier|floatformat:3 }} €/kWh</span>
        <span class="pill">Candidats testés : {{ optimisation_result.candidates_tested }}</span>
        <span class="pill">Solutions viables : {{ optimisation_result.feasible_candidates }}</span>
      </div>
    {% endif %}
  </section>

  <section style="margin-top:1.5rem;">
    <h2>Cartes tarifaires par membre</h2>
    <div class="grid member-grid">
      {% for card in member_cards %}
        <div class="card">
          <h3>{{ card.tariff.name }}</h3>
          {% if card.tariff.utility %}<p class="muted">{{ card.tariff.utility }}</p>{% endif %}
          {% if card.baseline %}
            <p class="muted">Consommation annuelle : {{ card.baseline.consumption_kwh|floatformat:0 }} kWh — Production : {{ card.baseline.production_kwh|floatformat:0 }} kWh</p>
          {% else %}
            <p class="muted">Aucune donnée temporelle exploitée pour ce membre.</p>
          {% endif %}

          <form method="post" action="{% url 'stage3_member_update' project.id card.tariff.member_id %}" style="margin-top:.75rem;">
            {% csrf_token %}
            <div class="form-grid">
              {% for field in card.form %}
                <label>{{ field.label }} {{ field }}</label>
              {% endfor %}
            </div>
            <button class="btn-small btn-secondary" type="submit" style="margin-top:.65rem;">Enregistrer la grille tarifaire</button>
          </form>

          <div style="margin-top:1rem;">
            <p class="muted">Décomposition (€/kWh) — total hors TVA : <strong>{{ card.tariff.total_unit_price_eur_per_kwh}}</strong> ({{ card.tariff.total_unit_price_eur_per_mwh|floatformat:1 }} €/MWh)</p>
            <table>
              <thead><tr><th>Composante</th><th>€/kWh</th></tr></thead>
              <tbody>
                <tr><td>Énergie (fournisseur)</td><td>{{ card.tariff.supplier_energy_price_eur_per_kwh}}</td></tr>
                <tr><td>Distribution (DSO)</td><td>{{ card.tariff.distribution_tariff_eur_per_kwh}}</td></tr>
                <tr><td>Transport (TSO)</td><td>{{ card.tariff.transport_tariff_eur_per_kwh}}</td></tr>
                <tr><td>Soutien énergie verte</td><td>{{ card.tariff.green_support_eur_per_kwh}}</td></tr>
                <tr><td>Redevance d'accès</td><td>{{ card.tariff.access_fee_eur_per_kwh}}</td></tr>
                <tr><td>Accise spéciale</td><td>{{ card.tariff.special_excise_eur_per_kwh}}</td></tr>
                <tr><td>Contribution énergie</td><td>{{ card.tariff.energy_contribution_eur_per_kwh}}</td></tr>
                <tr><td>Prix d'injection</td><td>{{ card.tariff.injection_price_eur_per_kwh}}</td></tr>
              </tbody>
            </table>
          </div>

          {% if card.baseline %}
            <div style="margin-top:.75rem;">
              <p class="muted">Facture de référence (hors communauté)</p>
              <ul class="muted" style="padding-left:1.1rem;">
                <li>Import réseau : {{ card.baseline.grid_import_kwh|floatformat:0 }} kWh</li>
                <li>Export réseau : {{ card.baseline.grid_export_kwh|floatformat:0 }} kWh</li>
                <li>Coût baseline : <strong>{{ card.baseline.cost_eur|floatformat:2 }} €</strong></li>
              </ul>
            </div>
          {% endif %}

          {% if card.community %}
            <div style="margin-top:.75rem; padding:.85rem; border-radius: 10px; background:#f0f5ff;">
              <p class="muted">Résultat communauté (prix {{ optimisation_result.optimal_price_eur_per_kwh|floatformat:3 }} €/kWh)</p>
              <ul class="muted" style="padding-left:1.1rem;">
                <li>Import communauté : {{ card.community.community_import_kwh|floatformat:0 }} kWh</li>
                <li>Export communauté : {{ card.community.community_export_kwh|floatformat:0 }} kWh</li>
                <li>Import réseau : {{ card.community.grid_import_kwh|floatformat:0 }} kWh — Export réseau : {{ card.community.grid_export_kwh|floatformat:0 }} kWh</li>
                <li>Coût communauté : <strong>{{ card.community.community_cost_eur|floatformat:2 }} €</strong></li>
                <li>Économie : <strong>{% if card.community.delta_eur >= 0 %}+{% endif %}{{ card.community.delta_eur|floatformat:2 }} €</strong> ({{ card.community.savings_pct|floatformat:1 }} %)</li>
              </ul>
            </div>
          {% endif %}
        </div>
      {% empty %}
        <p class="muted">Aucun membre n'est configuré pour ce projet.</p>
      {% endfor %}
    </div>
  </section>
</body>
</html>
