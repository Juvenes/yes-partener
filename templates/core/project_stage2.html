<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>{{ project.name }} — Stage 2 : Partage d'énergie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #f4f5fb; margin: 2rem; }
    a { color: #0d47a1; }
    h1 { margin-bottom: 0.5rem; }
    h2 { margin-top: 2.25rem; }
    .btn { display: inline-flex; align-items: center; justify-content: center; padding: .6rem 1rem; border-radius: 8px; border: none; background: #0d47a1; color: #fff; cursor: pointer; text-decoration: none; font-weight: 600; }
    .btn-secondary { background: #263238; }
    .btn-neutral { background: #5f6c85; }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .header { display: flex; justify-content: space-between; gap: 1rem; align-items: center; flex-wrap: wrap; }
    .breadcrumbs { font-size: .95rem; margin-bottom: .75rem; }
    .messages { list-style: none; margin: 1.5rem 0; padding: 0; }
    .messages li { padding: 1rem; border-radius: 10px; margin-bottom: .75rem; }
    .messages li.success { background: #e8f5e9; color: #1b5e20; }
    .messages li.error { background: #ffebee; color: #c62828; }
    .messages li.warning { background: #fff8e1; color: #ff8f00; }
    .card { background: #fff; border-radius: 14px; padding: 1.4rem 1.6rem; box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08); }
    .muted { color: #5f6368; font-size: .95rem; }
    .grid { display: grid; gap: 1.25rem; }
    .key-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.25rem; margin-top: 1.2rem; }
    .key-card { background: #fff; border-radius: 12px; padding: 1.2rem; box-shadow: 0 8px 20px rgba(30, 41, 59, 0.08); }
    .key-card h3 { margin-top: 0; margin-bottom: .4rem; }
    .key-card ul { margin: .4rem 0 0; padding-left: 1.1rem; font-size: .9rem; color: #455a64; }
    form label { font-size: .9rem; color: #1a237e; display: flex; flex-direction: column; gap: .35rem; }
    input, textarea, select { font: inherit; padding: .55rem .65rem; border-radius: 6px; border: 1px solid #cfd8dc; background: #fff; }
    textarea { resize: vertical; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .iteration-block { margin-top: 1.3rem; background: #f6f8ff; border-radius: 12px; padding: 1.1rem 1.3rem; }
    .iteration-block h3 { margin-top: 0; margin-bottom: .6rem; }
    .iteration-select { max-width: 260px; }
    .percentage-table { width: 100%; border-collapse: collapse; margin-top: .75rem; }
    .percentage-table th, .percentage-table td { border-bottom: 1px solid #dde3f0; padding: .55rem .35rem; text-align: left; font-size: .9rem; }
    .percentage-table th { font-weight: 600; color: #37474f; }
    .percentage-table input { width: 100%; }
    .scenario-section { margin-top: 2.5rem; }
    .scenario-card { background: #fff; border-radius: 14px; padding: 1.4rem 1.6rem; box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08); margin-bottom: 1.8rem; }
    .scenario-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; }
    .scenario-actions { display: flex; flex-wrap: wrap; gap: .5rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border-bottom: 1px solid #eceff1; padding: .75rem .5rem; text-align: left; font-size: .95rem; }
    th { font-weight: 600; color: #37474f; }
    tbody tr:hover { background: #f8f9ff; }
    .pill { display: inline-flex; align-items: center; padding: .25rem .6rem; border-radius: 999px; font-size: .8rem; background: #e3f2fd; color: #0d47a1; margin-right: .4rem; }
    .warning-box { margin-top: 1.2rem; background: #fff8e1; color: #bf6b00; padding: .85rem 1.1rem; border-radius: 10px; }
    .preview-table { font-size: .85rem; }
    .empty-state { text-align: center; padding: 2rem; color: #607d8b; background: #fff; border-radius: 14px; box-shadow: inset 0 0 0 1px rgba(96, 125, 139, 0.12); margin-top: 1.5rem; }
    .chart-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem; margin-top:1rem; }
    .chart-card { background:#f9fbff; border-radius:12px; padding:1rem; box-shadow: inset 0 0 0 1px rgba(13,71,161,0.08); }
    .chart-card.wide { grid-column: 1 / -1; }
    .sample-table { font-size:.85rem; }
    .iteration-summary { display:flex; flex-direction:column; gap:.6rem; margin-top:.75rem; }
    .iteration-bar { height: 16px; border-radius: 999px; overflow: hidden; display:flex; background:#e8eaf6; box-shadow: inset 0 0 0 1px rgba(13,71,161,0.12); }
    .iteration-bar__segment { height:100%; }
    @media (max-width: 720px) {
      .form-grid { grid-template-columns: 1fr; }
      .scenario-header { flex-direction: column; align-items: flex-start; }
      .scenario-actions { width: 100%; }
      .iteration-select { max-width: none; width: 100%; }
    }
  </style>
</head>
<body>
  <div class="breadcrumbs">
    <a href="{% url 'project_list' %}">Projets</a> · <a href="{% url 'project_detail' project.id %}">{{ project.name }}</a> · Stage 2
  </div>
  <div class="header">
    <div>
      <h1>{{ project.name }} — Stage 2 : Partage d'énergie</h1>
      <p class="muted">Définir les clés de partage pour répartir la production locale entre les membres et suivre les flux restants.</p>
    </div>
    <div class="scenario-actions">
      <a href="{% url 'project_detail' project.id %}" class="btn-secondary btn">Retour phase 1</a>
      <a href="{% url 'project_analysis_page' project.id %}" class="btn">Analyse des données</a>
      <a href="{% url 'project_stage3' project.id %}" class="btn-neutral btn">Stage 3</a>
    </div>
  </div>

  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li class="{{ message.tags }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <section class="card">
    <h2>Clés de partage disponibles</h2>
    <p class="muted">Stage 2 s'exécute sur chaque pas de 15 minutes : la production locale est allouée successivement selon vos itérations. Trois approches sont proposées et peuvent être combinées dans l'ordre de votre choix.</p>
    <div class="key-grid">
      <div class="key-card">
        <h3>Clé part égale</h3>
        <p class="muted">Chaque membre actif reçoit une part identique de l'énergie disponible, limitée par sa consommation restante.</p>
        <ul>
          <li>Simple et équilibrée lorsque les profils sont similaires.</li>
          <li>Ignorée pour les membres sans demande au pas considéré.</li>
        </ul>
      </div>
      <div class="key-card">
        <h3>Clé pourcentage fixe</h3>
        <p class="muted">Vous définissez une répartition contractuelle (somme = 100&nbsp;%). La part attribuée est plafonnée par la demande résiduelle.</p>
        <ul>
          <li>Idéal pour refléter un investissement ou un accord statique.</li>
          <li>Les valeurs peuvent être ajustées par itération.</li>
        </ul>
      </div>
      <div class="key-card">
        <h3>Clé proportionnelle à la consommation</h3>
        <p class="muted">La production est distribuée dynamiquement selon la consommation instantanée restante des membres.</p>
        <ul>
          <li>Maximise l'autoconsommation collective.</li>
          <li>Les membres sans demande sont ignorés automatiquement.</li>
        </ul>
      </div>
    </div>
  </section>

  {% if missing_members %}
    <div class="warning-box" style="margin-top:1.2rem;">
      <strong>Membres sans série temporelle :</strong>
      {% for member in missing_members %}{{ member.name }}{% if not forloop.last %}, {% endif %}{% endfor %}.
      Importez leurs données (Stage 1) pour qu'ils participent au partage.
    </div>
  {% endif %}

  {% if load_warnings %}
    <div class="warning-box">
      <strong>Attention :</strong>
      <ul style="margin:.4rem 0 0; padding-left:1.2rem;">
        {% for warn in load_warnings %}
          <li>{{ warn }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <section class="card" style="margin-top:2rem;">
    <h2>Créer un scénario Stage 2</h2>
    {% if not members_with_series %}
      <p class="muted">Ajoutez au moins un membre avec série temporelle pour configurer un scénario.</p>
    {% endif %}
    <form method="post" class="grid">
      {% csrf_token %}
      <div class="form-grid">
        <label>Nom du scénario
          {{ scenario_form.name }}
          {% if scenario_form.name.errors %}<span class="error">{{ scenario_form.name.errors|join:', ' }}</span>{% endif %}
        </label>
        <label>Notes
          {{ scenario_form.description }}
          {% if scenario_form.description.errors %}<span class="error">{{ scenario_form.description.errors|join:', ' }}</span>{% endif %}
        </label>
      </div>

      {% if scenario_form.non_field_errors %}
        <div class="warning-box">{{ scenario_form.non_field_errors|join:' ' }}</div>
      {% endif %}

      {% for block in iteration_blocks %}
        <div class="iteration-block">
          <div style="display:flex; align-items:center; justify-content: space-between; gap:1rem; flex-wrap:wrap;">
            <h3>Itération {{ block.index }}</h3>
            <div class="iteration-select">
              {{ block.type_field }}
            </div>
          </div>
          {% if block.type_field.errors %}
            <div class="warning-box" style="margin-top:.75rem;">{{ block.type_field.errors|join:', ' }}</div>
          {% endif %}
          {% if block.member_fields %}
            <p class="muted" style="margin:.75rem 0 .35rem;">Indiquez la répartition (total = 100&nbsp;%). Ces valeurs ne sont utilisées que pour la clé «&nbsp;pourcentage fixe&nbsp;».</p>
            <table class="percentage-table">
              <thead>
                <tr>
                  <th>Membre</th>
                  <th>Part (%)</th>
                </tr>
              </thead>
              <tbody>
                {% for field in block.member_fields %}
                  <tr>
                    <td>{{ field.label }}</td>
                    <td>
                      {{ field }}
                      {% if field.errors %}<div class="error">{{ field.errors|join:', ' }}</div>{% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endif %}
        </div>
      {% endfor %}

      <div>
        <button type="submit" class="btn" {% if not members_with_series %}disabled{% endif %}>Enregistrer le scénario</button>
      </div>
    </form>
  </section>

  <section class="scenario-section">
    <h2>Scénarios enregistrés</h2>
    {% if not scenario_cards %}
      <div class="empty-state">
        {% if members_with_series %}
          <p>Aucun scénario Stage 2 n'a encore été défini. Créez un scénario pour analyser la répartition de l'énergie.</p>
        {% else %}
          <p>Importez d'abord les données (Stage 1) afin de calculer la répartition communautaire.</p>
        {% endif %}
      </div>
    {% else %}
      {% for card in scenario_cards %}
        <div class="scenario-card">
          <div class="scenario-header">
            <div>
              <h3>{{ card.scenario.name }}</h3>
              {% if card.scenario.description %}<p class="muted">{{ card.scenario.description }}</p>{% endif %}
              <div>
                {% for config in card.iterations %}
                  <span class="pill">Itération {{ config.order }} · {{ config.label }}</span>
                {% endfor %}
              </div>
            </div>
            <div class="scenario-actions">
              <a href="{% url 'stage2_scenario_csv' card.scenario.id %}" class="btn" style="background:#1b5e20;">Exporter CSV</a>
            </div>
          </div>

          {% if card.error %}
            <div class="warning-box" style="margin-top:1rem;">{{ card.error }}</div>
          {% else %}
            <div class="grid" style="margin-top:1.2rem;">
              <div class="card" style="margin:0; background:#f4f7ff;">
                <h4 style="margin-top:0;">Synthèse</h4>
                <p class="muted">Énergie communautaire distribuée : <strong>{{ card.evaluation.total_community_allocation_kwh|floatformat:2 }} kWh</strong></p>
                <p class="muted">Production restant à partager : <strong>{{ card.evaluation.total_remaining_production_kwh|floatformat:2 }} kWh</strong></p>
                <p class="muted">Consommation non couverte : <strong>{{ card.evaluation.total_unserved_consumption_kwh|floatformat:2 }} kWh</strong></p>
              </div>

              <div class="card" style="margin:0;">
                <h4 style="margin-top:0;">Itérations</h4>
                {% if card.iteration_stats %}
                  <table class="preview-table">
                    <thead>
                      <tr>
                        <th>Itération</th>
                        <th>Clé</th>
                        <th>Énergie allouée (kWh)</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for stat in card.iteration_stats %}
                        <tr>
                          <td>{{ stat.order }}</td>
                          <td>{{ stat.key_type }}</td>
                          <td>{{ stat.allocated_kwh|floatformat:2 }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  <p class="muted">Aucune allocation enregistrée.</p>
                {% endif %}
              </div>
            </div>

            <div class="chart-card wide" style="margin-top:1rem;">
              <h4 style="margin:.2rem 0 0;">Itérations sur un pas de 15 minutes</h4>
              <p class="muted" style="margin:.25rem 0 .5rem;">Vue simplifiée du poids de chaque itération dans l'énergie partagée. La barre reflète la part relative des 3 itérations sans charger tout l'historique.</p>
              <div id="iteration-bar-{{ card.scenario.id }}" class="iteration-bar"></div>
              <div id="iteration-summary-{{ card.scenario.id }}" class="iteration-summary"></div>
            </div>

            <div class="chart-grid">
              <div class="chart-card">
                <h4 style="margin:.2rem 0 0;">Partage mensuel par membre</h4>
                <p class="muted" style="margin:.25rem 0 .5rem;">Empilement des allocations communautaires par clé sur le calendrier normalisé.</p>
                <canvas id="chart-monthly-{{ card.scenario.id }}" height="200"></canvas>
              </div>
              <div class="chart-card">
                <h4 style="margin:.2rem 0 0;">Flux mensuels</h4>
                <p class="muted" style="margin:.25rem 0 .5rem;">Production totale vs énergie partagée, reliquats et consommation restante.</p>
                <canvas id="chart-balance-{{ card.scenario.id }}" height="200"></canvas>
              </div>
              <div class="chart-card">
                <h4 style="margin:.2rem 0 0;">Contribution des itérations</h4>
                <p class="muted" style="margin:.25rem 0 .5rem;">Énergie allouée par clé (égale, pourcentage, proportionnelle).</p>
                <canvas id="chart-iterations-{{ card.scenario.id }}" height="200"></canvas>
              </div>
              <div class="chart-card">
                <h4 style="margin:.2rem 0 0;">Hebdomadaire</h4>
                <p class="muted" style="margin:.25rem 0 .5rem;">Vue agrégée par semaine ISO pour repérer les pics de demande et d'injection.</p>
                <canvas id="chart-weekly-{{ card.scenario.id }}" height="200"></canvas>
              </div>
            </div>

            <h4 style="margin-top:1.8rem;">Répartition par membre</h4>
            <table>
              <thead>
                <tr>
                  <th>Membre</th>
                  <th>Production totale (kWh)</th>
                  <th>Part partagée (kWh)</th>
                  <th>Production restante (kWh)</th>
                  <th>Consommation totale (kWh)</th>
                  <th>Couverture communauté (kWh)</th>
                  <th>Consommation résiduelle (kWh)</th>
                </tr>
              </thead>
              <tbody>
                {% for summary in card.member_summaries %}
                  <tr>
                    <td>{{ summary.member_name }}</td>
                    <td>{{ summary.total_production_kwh|floatformat:2 }}</td>
                    <td>{{ summary.shared_production_kwh|floatformat:2 }}</td>
                    <td>{{ summary.unused_production_kwh|floatformat:2 }}</td>
                    <td>{{ summary.total_consumption_kwh|floatformat:2 }}</td>
                    <td>{{ summary.community_consumption_kwh|floatformat:2 }}</td>
                    <td>{{ summary.external_consumption_kwh|floatformat:2 }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>

            {% if card.preview %}
              <details style="margin-top:1.6rem;">
                <summary>Prévisualiser les 6 premiers pas de temps</summary>
                <table class="preview-table">
                  <thead>
                    <tr>
                      <th>Horodatage</th>
                      <th>Énergie communautaire (kWh)</th>
                      <th>Production restante (kWh)</th>
                      <th>Consommation résiduelle (kWh)</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in card.preview %}
                      <tr>
                        <td>{{ row.timestamp }}</td>
                        <td>{{ row.community_allocated_kwh|floatformat:2 }}</td>
                        <td>{{ row.remaining_production_kwh|floatformat:2 }}</td>
                        <td>{{ row.remaining_consumption_kwh|floatformat:2 }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </details>
            {% endif %}

            <h4 style="margin-top:1.6rem;">Cas illustratifs</h4>
            <p class="muted">Exemples de pas de temps où le partage est actif : qui consomme, combien est pris et ce qu'il reste.</p>
            <table class="sample-table">
              <thead>
                <tr>
                  <th>Horodatage</th>
                  <th>Prod. (kWh)</th>
                  <th>Conso. (kWh)</th>
                  <th>Partagée (kWh)</th>
                  <th>Prod. restante</th>
                  <th>Conso. restante</th>
                  <th>Détails membres</th>
                </tr>
              </thead>
              <tbody id="samples-{{ card.scenario.id }}"></tbody>
            </table>
            <script type="application/json" id="viz-{{ card.scenario.id }}">{{ card.viz_payload|safe }}</script>

            {% if card.warnings %}
              <div class="warning-box" style="margin-top:1.2rem;">
                <strong>Observations :</strong>
                <ul style="margin:.4rem 0 0; padding-left:1.2rem;">
                  {% for warn in card.warnings %}
                    <li>{{ warn }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          {% endif %}
        </div>
      {% endfor %}
    {% endif %}
  </section>
</body>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function() {
    const palette = ['#0d47a1', '#1976d2', '#42a5f5', '#66bb6a', '#00897b', '#ffb300', '#8e24aa', '#ef6c00'];

    function renderSamples(samples, targetId) {
      const tbody = document.getElementById(targetId);
      if (!tbody) return;
      tbody.innerHTML = '';
      samples.forEach((row, idx) => {
        const tr = document.createElement('tr');
        const cells = [row.timestamp, row.production.toFixed(2), row.consumption.toFixed(2), row.allocated.toFixed(2), row.remaining_production.toFixed(2), row.remaining_consumption.toFixed(2)];
        cells.forEach(value => {
          const td = document.createElement('td');
          td.textContent = value;
          tr.appendChild(td);
        });
        const memberTd = document.createElement('td');
        const details = document.createElement('details');
        const summary = document.createElement('summary');
        summary.textContent = 'Répartition membres';
        details.appendChild(summary);
        const list = document.createElement('ul');
        list.style.margin = '0.35rem 0 0';
        list.style.paddingLeft = '1rem';
        row.members.forEach(m => {
          const li = document.createElement('li');
          li.textContent = `${m.name} : +${m.community.toFixed(2)} kWh / reste conso ${m.external.toFixed(2)} kWh / prod inutilisée ${m.unused_prod.toFixed(2)} kWh`;
          list.appendChild(li);
        });
        details.appendChild(list);
        memberTd.appendChild(details);
        tr.appendChild(memberTd);
        tbody.appendChild(tr);
      });
    }

    function renderIterationBar(payload, scenarioId) {
      const bar = document.getElementById(`iteration-bar-${scenarioId}`);
      const list = document.getElementById(`iteration-summary-${scenarioId}`);
      if (!bar || !list || !payload.iteration_chart || !payload.iteration_chart.length) return;

      const total = payload.iteration_chart.reduce((sum, item) => sum + (item.value || 0), 0) || 1;
      bar.innerHTML = '';
      list.innerHTML = '';

      payload.iteration_chart.forEach((item, idx) => {
        const pct = Math.round((item.value / total) * 1000) / 10; // one decimal
        const seg = document.createElement('div');
        seg.className = 'iteration-bar__segment';
        seg.style.width = `${Math.max(pct, 1)}%`;
        seg.style.background = palette[idx % palette.length];
        bar.appendChild(seg);

        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        row.style.gap = '.5rem';

        const label = document.createElement('div');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '.4rem';
        const dot = document.createElement('span');
        dot.style.width = '12px';
        dot.style.height = '12px';
        dot.style.borderRadius = '50%';
        dot.style.background = palette[idx % palette.length];
        const text = document.createElement('span');
        text.textContent = item.label;
        label.appendChild(dot);
        label.appendChild(text);

        const val = document.createElement('strong');
        val.textContent = `${item.value.toFixed(2)} kWh (${pct.toFixed(1)}%)`;

        row.appendChild(label);
        row.appendChild(val);
        list.appendChild(row);
      });
    }

    function renderCharts(payload, scenarioId) {
      if (!payload.has_data) return;
      const monthLabels = payload.months;

      renderIterationBar(payload, scenarioId);

      const monthlyCtx = document.getElementById(`chart-monthly-${scenarioId}`);
      if (monthlyCtx && payload.member_monthly.length) {
        new Chart(monthlyCtx, {
          type: 'bar',
          data: {
            labels: monthLabels,
            datasets: payload.member_monthly.map((series, idx) => ({
              label: series.member,
              data: series.values,
              backgroundColor: palette[idx % palette.length],
              stack: 'community'
            })),
          },
          options: {
            responsive: true,
            scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: 'kWh partagés' } } }
          }
        });
      }

      const balanceCtx = document.getElementById(`chart-balance-${scenarioId}`);
      if (balanceCtx) {
        new Chart(balanceCtx, {
          type: 'line',
          data: {
            labels: monthLabels,
            datasets: [
              { label: 'Production', data: payload.monthly_totals.map(v => v.production), borderColor: '#1b5e20', backgroundColor: 'rgba(27,94,32,0.1)', tension: 0.2 },
              { label: 'Partagée', data: payload.monthly_totals.map(v => v.community), borderColor: '#0d47a1', backgroundColor: 'rgba(13,71,161,0.15)', tension: 0.2 },
              { label: 'Prod. restante', data: payload.monthly_totals.map(v => v.remaining_production), borderColor: '#ef6c00', backgroundColor: 'rgba(239,108,0,0.15)', tension: 0.2 },
              { label: 'Conso. restante', data: payload.monthly_totals.map(v => v.remaining_consumption), borderColor: '#c62828', backgroundColor: 'rgba(198,40,40,0.12)', tension: 0.2 },
            ]
          },
          options: { responsive: true, interaction: { mode: 'index', intersect: false }, stacked: false }
        });
      }

      const iterationCtx = document.getElementById(`chart-iterations-${scenarioId}`);
      if (iterationCtx && payload.iteration_chart.length) {
        new Chart(iterationCtx, {
          type: 'doughnut',
          data: {
            labels: payload.iteration_chart.map(v => v.label),
            datasets: [{
              data: payload.iteration_chart.map(v => v.value),
              backgroundColor: payload.iteration_chart.map((_, idx) => palette[idx % palette.length])
            }]
          },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
      }

      const weeklyCtx = document.getElementById(`chart-weekly-${scenarioId}`);
      if (weeklyCtx && payload.weekly_totals.length) {
        const weekLabels = payload.weekly_totals.map(v => `S${v.week}`);
        new Chart(weeklyCtx, {
          type: 'bar',
          data: {
            labels: weekLabels,
            datasets: [
              { label: 'Partagée', data: payload.weekly_totals.map(v => v.community), backgroundColor: '#0d47a1' },
              { label: 'Production', data: payload.weekly_totals.map(v => v.production), backgroundColor: 'rgba(27,94,32,0.7)' },
              { label: 'Conso. restante', data: payload.weekly_totals.map(v => v.remaining_consumption), backgroundColor: '#c62828' },
            ]
          },
          options: { responsive: true, interaction: { mode: 'index', intersect: false }, scales: { y: { stacked: false, title: { display: true, text: 'kWh' } } } }
        });
      }

      renderSamples(payload.samples, `samples-${scenarioId}`);
    }

    document.querySelectorAll('script[id^="viz-"]').forEach(node => {
      try {
        const payload = JSON.parse(node.textContent || '{}');
        const scenarioId = node.id.replace('viz-', '');
        renderCharts(payload, scenarioId);
      } catch (err) {
        console.error('Impossible de charger les visualisations Stage 2', err);
      }
    });
  })();
</script>
</html>
