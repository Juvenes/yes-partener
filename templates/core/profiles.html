{% extends "core/base.html" %}

{% block title %}Profils – MobiWAN{% endblock %}

{% block content %}
  <h1>Gestion des Profils</h1>
  <p class="muted">Créez et gérez les profils de consommation et de production ici.</p>

  <div class="grid">
    <div class="card">
      <h3>Créer un nouveau profil (année complète)</h3>
      <form method="post" action="{% url 'profile_create' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <label>Nom du profil</label>
        <input class="input" type="text" name="name" required>
        <label>Type de profil</label>
        <select class="input" name="profile_type" required>
          <option value="consumption">Consommation (ConsoType)</option>
          <option value="production">Production (ProdType)</option>
        </select>
        <label style="margin-top:.5rem">Fichier (CSV ou Excel, 35 040 lignes)</label>
        <input class="input" type="file" name="profile_csv" accept=".csv,.xls,.xlsx" required>
        <p class="muted">Horodatage sur une année complète avec pas de 15 minutes. Les colonnes numériques sont détectées automatiquement ("1 kWh" ou "Prod (1 kWh)").</p>
        <button class="btn" type="submit" style="margin-top:.75rem">Créer le profil</button>
      </form>
    </div>

    <div class="card">
      <h3>Profils existants</h3>
      <table>
        <thead>
          <tr><th>Nom</th><th>Type</th><th>Lignes</th><th>Total (kWh)</th><th>Graphique</th></tr>
        </thead>
        <tbody>
          {% for p in profiles %}
            <tr>
              <td>{{ p.name }}</td>
              <td>{{ p.get_profile_type_display }}</td>
              <td>{% if p.metadata %}{{ p.metadata.row_count }}{% else %}—{% endif %}</td>
              <td>
                {% if p.metadata %}
                  {% if p.profile_type == 'production' %}
                    {{ p.metadata.totals.value_kwh|floatformat:0 }}
                  {% else %}
                    {{ p.metadata.totals.value_kwh|floatformat:0 }}
                  {% endif %}
                {% else %}—{% endif %}
              </td>
              <td>
                {% if p.graph %}
                  <img src="{{ p.graph.url }}" alt="Graph of {{ p.name }}" style="max-width: 100px;">
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="5" class="muted">Aucun profil pour l’instant.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}