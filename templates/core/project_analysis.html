<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Analyse du projet : {{ project.name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    body { font-family: system-ui, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 2rem; }
    .container { max-width: 1600px; margin: 0 auto; }
    .card { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 2rem; }
    h1, h2 { color: #1a253c; }
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
    .kpi-card { background: #fff; border: 1px solid #eef; padding: 1.5rem; border-radius: 12px; text-align: center; }
    .kpi-value { font-size: 2.5rem; font-weight: 700; color: #2c3e50; }
    .kpi-label { font-size: 1rem; color: #7f8c8d; margin-top: 0.5rem; }
    .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
    .btn-back { display: inline-block; margin-bottom: 2rem; padding: .75rem 1.5rem; background: #34495e; color: #fff; text-decoration: none; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="{% url 'project_detail' project.id %}" class="btn-back">&larr; Retour au projet</a>
    <h1> Tableau de bord analytique : {{ project.name }}</h1>

    <h2>Chiffres Clés sur 24h</h2>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-value">{{ kpis.total_production|floatformat:0 }} kWh</div>
        <div class="kpi-label">⚡️ Production Totale</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value">{{ kpis.total_consumption|floatformat:0 }} kWh</div>
        <div class="kpi-label"> Consommation Totale</div>
      </div>
      <div class="kpi-card" style="background-color: {% if kpis.net_surplus > 0 %}#e8f5e9{% else %}#ffebee{% endif %};">
        <div class="kpi-value" style="color: {% if kpis.net_surplus > 0 %}#2e7d32{% else %}#c62828{% endif %};">{{ kpis.net_surplus|floatformat:0 }} kWh</div>
        <div class="kpi-label"> Surplus / Déficit Net</div>
      </div>
       <div class="kpi-card">
        <div class="kpi-value">{{ kpis.autonomy_coverage|floatformat:2 }} %</div>
        <div class="kpi-label"> Taux d'autonomie du groupe</div>
      </div>
    </div>
    
    <div class="card" style="margin-top: 2rem;">
        <h2>Analyse Temporelle (Production & Consommation)</h2>
        <div id="main-chart"></div>
    </div>
    
    <div class="card">
        <h2>Analyse du Surplus / Déficit</h2>
        <div id="surplus-chart"></div>
    </div>

    <div class="chart-grid">
        <div class="card">
            <h2> Top 5 Producteurs</h2>
            <div id="producers-pie"></div>
        </div>
        <div class="card">
            <h2> Top 5 Consommateurs</h2>
            <div id="consumers-pie"></div>
        </div>
    </div>

  </div>

  <script>
    const timestamps = {{ timestamps|safe }};
    const seriesData = {{ series_data|safe }};
    const surplusSeries = {{ surplus_series|safe }};
    const pieProducers = {{ pie_producers|safe }};
    const pieConsumers = {{ pie_consumers|safe }};

    // --- Graphique Principal ---
    const mainChartOptions = {
      series: seriesData,
      chart: { type: 'line', height: 450, zoom: { enabled: true } },
      stroke: { width: 2, curve: 'smooth' },
      xaxis: { categories: timestamps },
      title: { text: 'Production et Consommation par membre', align: 'left' },
      legend: { position: 'top', horizontalAlign: 'right', floating: true, offsetY: -25, offsetX: -5 },
      tooltip: { y: { formatter: (val) => val.toFixed(2) + " kWh" } }
    };
    const mainChart = new ApexCharts(document.querySelector("#main-chart"), mainChartOptions);
    mainChart.render();
    
    // --- Graphique de Surplus ---
    const surplusChartOptions = {
        series: [{ name: 'Surplus/Déficit', data: surplusSeries }],
        chart: { type: 'area', height: 250 },
        colors: ['#008FFB'],
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: 2 },
        xaxis: { categories: timestamps },
        title: { text: 'Surplus (bleu) et Déficit (rouge) du groupe', align: 'left' },
        tooltip: { y: { formatter: (val) => val.toFixed(2) + " kWh" } },
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.9,
                stops: [0, 90, 100]
            }
        },
        // Colorer le surplus en bleu et le déficit en rouge
        markers: {
            colors: surplusSeries.map(val => val < 0 ? '#FF4560' : '#008FFB')
        }
    };
    const surplusChart = new ApexCharts(document.querySelector("#surplus-chart"), surplusChartOptions);
    surplusChart.render();


    // --- Graphiques Circulaires ---
    const pieOptions = (title, labels, data) => ({
      series: data,
      chart: { type: 'donut', height: 350 },
      labels: labels,
      title: { text: title },
      responsive: [{ breakpoint: 480, options: { chart: { width: 200 }, legend: { position: 'bottom' } } }]
    });

    const producersPie = new ApexCharts(document.querySelector("#producers-pie"), pieOptions('Répartition de la production (kWh)', pieProducers.labels, pieProducers.data));
    producersPie.render();
    
    const consumersPie = new ApexCharts(document.querySelector("#consumers-pie"), pieOptions('Répartition de la consommation (kWh)', pieConsumers.labels, pieConsumers.data));
    consumersPie.render();

  </script>
</body>
</html>