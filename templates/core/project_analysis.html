<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Analyse du projet : {{ project.name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    body { font-family: system-ui, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 2rem; }
    .container { max-width: 1600px; margin: 0 auto; }
    .card { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 2rem; }
    h1, h2 { color: #1a253c; margin-top: 0; }
    .btn-back { display: inline-block; margin-bottom: 0; padding: .75rem 1.5rem; background: #34495e; color: #fff; text-decoration: none; border-radius: 8px; }
    .header-bar { display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; }
    .header-left { display: flex; flex-direction: column; gap: 0.75rem; }
    .action-buttons { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .btn-primary, .btn-secondary { display: inline-block; padding: .75rem 1.3rem; border-radius: 8px; color: #fff; text-decoration: none; font-weight: 600; }
    .btn-primary { background: #0d47a1; }
    .btn-secondary { background: #5f6c85; }
    .section-nav { display: flex; flex-wrap: wrap; gap: .75rem; margin: 1rem 0 1.5rem; }
    .section-nav a { padding: .65rem 1.1rem; border-radius: 10px; background: #eef2ff; color: #1a253c; text-decoration: none; font-weight: 700; box-shadow: inset 0 0 0 1px rgba(13,71,161,.1); }
    .section-nav a:hover { background: #e0e7ff; }
    .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .meta-chip { background: #eef2ff; border-radius: 10px; padding: .85rem 1rem; box-shadow: inset 0 0 0 1px rgba(52,73,94,.08); }
    .meta-chip strong { display: block; font-size: .8rem; color: #556987; text-transform: uppercase; letter-spacing: .08em; margin-bottom: .35rem; }
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; }
    .kpi-card { background: linear-gradient(145deg, #ffffff, #f6f8ff); border-radius: 14px; padding: 1.75rem; box-shadow: 0 12px 30px rgba(31,61,90,.08); }
    .kpi-value { font-size: 2.5rem; font-weight: 700; color: #1a253c; }
    .kpi-label { font-size: 1rem; color: #6b7c93; margin-top: 0.35rem; }
    .chart-grid { display: flex; flex-direction: column; gap: 2rem; }
    .input-select { padding: .65rem 1rem; border-radius: 8px; border: 1px solid #cfd6e3; font-size: 1rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 0.85rem 0.5rem; border-bottom: 1px solid #e6ecf5; }
    th { color: #5f6c85; font-weight: 600; }
    tr:hover td { background: #f8fbff; }
    .muted { color: #7b8a9a; font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-bar">
      <div class="header-left">
        <a href="{% url 'project_detail' project.id %}" class="btn-back">&larr; Retour au projet</a>
        <h1>Simulation complète : {{ project.name }}</h1>
        <p class="muted">Cette page regroupe toutes les analyses en une seule vue, avec les graphiques empilés pour éviter les ralentissements.</p>
      </div>
      <div class="action-buttons">
        <a href="{% url 'project_detail' project.id %}" class="btn-secondary">Étape 1 · Import membres</a>
        <a href="{% url 'project_stage2' project.id %}" class="btn-secondary">Étape 2 · Clés de partage</a>
        <a href="{% url 'project_stage3' project.id %}" class="btn-primary">Étape 3 · Tarifs &amp; optimisation</a>
      </div>
    </div>

    <div class="section-nav">
      <a href="#coverage">Couverture des données</a>
      <a href="#kpis">Chiffres clés</a>
      <a href="#monthly">Production vs consommation</a>
      <a href="#chroniques">Chroniques détaillées</a>
      <a href="#members">Vue par membre</a>
    </div>

    <div class="card" id="coverage">
      <h2>Couverture des données</h2>
      <div class="meta-grid">
        <div class="meta-chip">
          <strong>Nombre de lignes</strong>
          <span>{{ aggregate_metadata.row_count }}</span>
        </div>
        <div class="meta-chip">
          <strong>Période couverte</strong>
          <span>{% if aggregate_metadata.start %}{{ aggregate_metadata.start|slice:":10" }} → {{ aggregate_metadata.end|slice:":10" }}{% else %}—{% endif %}</span>
        </div>
        <div class="meta-chip">
          <strong>Granularité détectée</strong>
          <span>{% if aggregate_metadata.granularity_minutes %}{{ aggregate_metadata.granularity_minutes|floatformat:0 }} minutes{% else %}—{% endif %}</span>
        </div>
        <div class="meta-chip">
          <strong>Jours couverts</strong>
          <span>{% if aggregate_metadata.coverage_days %}{{ aggregate_metadata.coverage_days|floatformat:1 }} jours{% else %}—{% endif %}</span>
        </div>
        <div class="meta-chip">
          <strong>Manques estimés</strong>
          <span>{% if aggregate_metadata.missing_rows %}{{ aggregate_metadata.missing_rows }} lignes{% else %}0{% endif %}</span>
        </div>
        <div class="meta-chip">
          <strong>Année normalisée</strong>
          <span>{% if aggregate_metadata.normalized_year %}{{ aggregate_metadata.normalized_year }}{% else %}—{% endif %}</span>
        </div>
      </div>
    </div>

    <h2 id="kpis">Chiffres clés</h2>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-value">{{ kpis.total_production|floatformat:0 }} kWh</div>
        <div class="kpi-label">Production totale</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value">{{ kpis.total_consumption|floatformat:0 }} kWh</div>
        <div class="kpi-label">Consommation totale</div>
      </div>
      <div class="kpi-card" style="background: {% if kpis.net_surplus >= 0 %}#e8f5e9{% else %}#ffebee{% endif %};">
        <div class="kpi-value" style="color: {% if kpis.net_surplus >= 0 %}#2e7d32{% else %}#c62828{% endif %};">{{ kpis.net_surplus|floatformat:0 }} kWh</div>
        <div class="kpi-label">Solde net</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value">{{ kpis.autonomy_coverage|floatformat:1 }} %</div>
        <div class="kpi-label">Autonomie du groupe</div>
      </div>
    </div>

    <div class="card" id="monthly" style="margin-top: 2rem;">
      <h2>Production vs consommation par mois</h2>
      <div id="monthly-chart"></div>
    </div>

    <div class="card" id="chroniques" style="margin-top: 2rem;">
      <div style="display:flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <h2>Exploration détaillée par mois</h2>
        <select id="month-select" class="input-select"></select>
      </div>
      <p style="color: #6b7c93; margin: 0.75rem 0 1.5rem;">Choisissez un mois pour visualiser toutes les séries par membre, les injections, les consommations et le solde net.</p>
      <div class="chart-grid" style="margin-bottom: 1.5rem;">
        <div id="month-production-chart" class="card" style="box-shadow:none;border:1px solid #eef2ff;"></div>
        <div id="month-consumption-chart" class="card" style="box-shadow:none;border:1px solid #eef2ff;"></div>
      </div>
      <div id="month-balance-chart"></div>
    </div>

    <div class="chart-grid">
      <div class="card">
        <h2>Profil moyen sur 24h</h2>
        <div id="avg-chart"></div>
      </div>
      <div class="card">
        <h2>Vue hebdomadaire (année complète)</h2>
        <div id="weekly-balance"></div>
        <div id="weekly-production"></div>
        <div id="weekly-consumption"></div>
      </div>
    </div>

    <div class="chart-grid" id="members">
      <div class="card">
        <h2>Top 5 producteurs</h2>
        <div id="producers-pie"></div>
      </div>
      <div class="card">
        <h2>Top 5 consommateurs</h2>
        <div id="consumers-pie"></div>
      </div>
    </div>

    <div class="card">
      <h2>Détails par membre</h2>
      <table>
        <thead>
          <tr>
            <th>Membre</th>
            <th>Lignes</th>
            <th>Période</th>
            <th>Année</th>
            <th>Consommation (kWh)</th>
            <th>Production (kWh)</th>
          </tr>
        </thead>
        <tbody>
          {% for item in member_stats %}
            <tr>
              <td>{{ item.member.name }}</td>
              <td>{{ item.metadata.row_count }}</td>
              <td>
                {% if item.metadata.start %}
                  {{ item.metadata.start|slice:":10" }} → {{ item.metadata.end|slice:":10" }}
                {% else %}—{% endif %}
              </td>
              <td>{% if item.metadata.normalized_year %}{{ item.metadata.normalized_year }}{% else %}—{% endif %}</td>
              <td>{{ item.total_consumption|floatformat:0 }}</td>
              <td>{{ item.total_production|floatformat:0 }}</td>
            </tr>
            {% empty %}
              <tr><td colspan="6" class="muted">Aucune donnée disponible.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const monthlyCategories = {{ monthly_categories|safe }};
    const monthlySeries = {{ monthly_series|safe }};
    const monthlyDetail = {{ monthly_detail|default:'[]'|safe }};
    const avgProfileCategories = {{ avg_profile_categories|safe }};
    const avgProfileSeries = {{ avg_profile_series|safe }};
    const weeklyCategories = {{ weekly_categories|default:'[]'|safe }};
    const weeklyTotals = {{ weekly_totals|default:'{}'|safe }};
    const weeklyMemberProduction = {{ weekly_member_production|default:'[]'|safe }};
    const weeklyMemberConsumption = {{ weekly_member_consumption|default:'[]'|safe }};
    const pieProducers = {{ pie_producers|safe }};
    const pieConsumers = {{ pie_consumers|safe }};

    const monthlyChart = new ApexCharts(document.querySelector('#monthly-chart'), {
      series: [
        { name: 'Production', type: 'column', data: monthlySeries.production },
        { name: 'Consommation', type: 'column', data: monthlySeries.consumption },
        { name: 'Solde net', type: 'line', data: monthlySeries.net }
      ],
      chart: { type: 'line', height: 420, stacked: false },
      stroke: { width: [0, 0, 3], curve: 'smooth' },
      dataLabels: { enabled: false },
      xaxis: { categories: monthlyCategories },
      yaxis: [{ title: { text: 'kWh' } }],
      tooltip: { shared: true }
    });
    monthlyChart.render();

    const monthSelect = document.querySelector('#month-select');
    const monthProdContainer = document.querySelector('#month-production-chart');
    const monthConsContainer = document.querySelector('#month-consumption-chart');
    const monthBalanceContainer = document.querySelector('#month-balance-chart');
    let monthProdChart = null;
    let monthConsChart = null;
    let monthBalanceChart = null;

    function clearContainers(message) {
      monthProdContainer.innerHTML = message;
      monthConsContainer.innerHTML = '';
      monthBalanceContainer.innerHTML = '';
    }

    function renderMonthChart(index) {
      if (!monthlyDetail.length) {
        clearContainers('<p class="muted">Aucune donnée détaillée disponible.</p>');
        monthSelect.disabled = true;
        return;
      }

      const monthData = monthlyDetail[index] || monthlyDetail[0];
      if (!monthData) {
        clearContainers('<p class="muted">Données indisponibles pour ce mois.</p>');
        return;
      }

      monthSelect.value = String(index);

      [monthProdChart, monthConsChart, monthBalanceChart].forEach((chart) => {
        if (chart) chart.destroy();
      });

      const stackedOptions = (title, series) => ({
        series,
        chart: { type: 'area', height: 360, stacked: true, toolbar: { show: false } },
        title: { text: title },
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: 2 },
        xaxis: { categories: monthData.categories, labels: { rotate: -35 } },
        yaxis: { title: { text: 'kWh' } },
        tooltip: { shared: true },
        fill: { opacity: 0.8 }
      });

      monthProdChart = new ApexCharts(
        monthProdContainer,
        stackedOptions('Production quotidienne par membre', monthData.production_series)
      );
      monthProdChart.render();

      monthConsChart = new ApexCharts(
        monthConsContainer,
        stackedOptions('Consommation quotidienne par membre', monthData.consumption_series)
      );
      monthConsChart.render();

      monthBalanceChart = new ApexCharts(monthBalanceContainer, {
        series: [
          { name: 'Production totale', type: 'column', data: monthData.totals.production },
          { name: 'Consommation totale', type: 'column', data: monthData.totals.consumption },
          { name: 'Solde net', type: 'line', data: monthData.totals.net }
        ],
        chart: { type: 'line', height: 420, stacked: false, zoom: { enabled: false }, toolbar: { show: false } },
        stroke: { curve: 'smooth', width: [0, 0, 3] },
        plotOptions: { bar: { columnWidth: '55%' } },
        fill: { opacity: [0.85, 0.85, 0.3] },
        xaxis: {
          categories: monthData.categories,
          tickAmount: Math.min(12, monthData.categories.length),
          labels: { rotate: -35 }
        },
        yaxis: [{ title: { text: 'kWh' } }],
        dataLabels: { enabled: false },
        tooltip: { shared: true }
      });
      monthBalanceChart.render();
    }

    function populateMonthSelect() {
      monthSelect.innerHTML = '';
      monthlyDetail.forEach((entry, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.textContent = entry.label;
        monthSelect.appendChild(option);
      });
    }

    populateMonthSelect();
    if (monthlyDetail.length) {
      renderMonthChart(0);
      monthSelect.addEventListener('change', (event) => {
        renderMonthChart(Number(event.target.value));
      });
    } else {
      renderMonthChart(0);
    }

    const avgChart = new ApexCharts(document.querySelector('#avg-chart'), {
      series: [
        { name: 'Production moyenne', data: avgProfileSeries.production },
        { name: 'Consommation moyenne', data: avgProfileSeries.consumption }
      ],
      chart: { type: 'line', height: 360 },
      stroke: { curve: 'smooth', width: 2 },
      xaxis: { categories: avgProfileCategories, tickAmount: 8 },
      dataLabels: { enabled: false },
      tooltip: { shared: true, y: { formatter: (val) => `${val.toFixed(2)} kWh` } }
    });
    avgChart.render();

    const weeklyBalance = new ApexCharts(document.querySelector('#weekly-balance'), {
      series: [
        { name: 'Production', type: 'column', data: weeklyTotals.production || [] },
        { name: 'Consommation', type: 'column', data: weeklyTotals.consumption || [] },
        { name: 'Solde net', type: 'line', data: weeklyTotals.net || [] }
      ],
      chart: { type: 'line', height: 360, stacked: false, toolbar: { show: false } },
      stroke: { width: [0, 0, 3], curve: 'smooth' },
      plotOptions: { bar: { columnWidth: '50%' } },
      dataLabels: { enabled: false },
      xaxis: { categories: weeklyCategories, title: { text: 'Semaine (ISO)' } },
      yaxis: [{ title: { text: 'kWh' } }],
      tooltip: { shared: true }
    });
    weeklyBalance.render();

    const weeklyProd = new ApexCharts(document.querySelector('#weekly-production'), {
      series: weeklyMemberProduction,
      chart: { type: 'area', stacked: true, height: 280, toolbar: { show: false } },
      title: { text: 'Production hebdomadaire par membre' },
      dataLabels: { enabled: false },
      stroke: { curve: 'smooth', width: 2 },
      xaxis: { categories: weeklyCategories, title: { text: 'Semaine (ISO)' } },
      yaxis: { title: { text: 'kWh' } },
      tooltip: { shared: true },
      fill: { opacity: 0.8 }
    });
    weeklyProd.render();

    const weeklyCons = new ApexCharts(document.querySelector('#weekly-consumption'), {
      series: weeklyMemberConsumption,
      chart: { type: 'area', stacked: true, height: 280, toolbar: { show: false } },
      title: { text: 'Consommation hebdomadaire par membre' },
      dataLabels: { enabled: false },
      stroke: { curve: 'smooth', width: 2 },
      xaxis: { categories: weeklyCategories, title: { text: 'Semaine (ISO)' } },
      yaxis: { title: { text: 'kWh' } },
      tooltip: { shared: true },
      fill: { opacity: 0.8 }
    });
    weeklyCons.render();

    const safePie = (data, placeholder) => {
      if (!data.data || data.data.length === 0) {
        return { labels: [placeholder], data: [0] };
      }
      return data;
    };

    const pieOptions = (title, data) => ({
      series: data.data,
      chart: { type: 'donut', height: 350 },
      labels: data.labels,
      title: { text: title },
      dataLabels: { formatter: (val, opts) => `${opts.w.globals.series[opts.seriesIndex].toFixed(0)} kWh` }
    });

    new ApexCharts(
      document.querySelector('#producers-pie'),
      pieOptions('Répartition production', safePie(pieProducers, 'Aucune donnée'))
    ).render();
    new ApexCharts(
      document.querySelector('#consumers-pie'),
      pieOptions('Répartition consommation', safePie(pieConsumers, 'Aucune donnée'))
    ).render();
  </script>
</body>
</html>
