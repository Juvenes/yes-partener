<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>{{ project.name }} – Phase 1 : Datasets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; max-width: 1200px; background-color: #f9f9f9; }
    .grid { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; align-items: start; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem; background-color: #fff; }
    .input, select { padding: .75rem; border: 1px solid #ccc; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 1rem; margin-bottom: 0.5rem; }
    select[multiple] { height: 120px; }
    .btn { padding: .75rem 1.25rem; border-radius: 8px; border: none; background: #222; color: #fff; cursor: pointer; font-size: 1rem; }
    .btn-group { display: flex; gap: .75rem; flex-wrap: wrap; }
    table { width:100%; border-collapse: collapse; font-size: 1.05rem; }
    th, td { border-bottom: 1px solid #eee; padding: 1rem .5rem; text-align: left; vertical-align: top; }
    th { font-weight: 600; color: #555; }
    .muted { color: #666; font-size: .9rem; }
    .messages { list-style: none; padding: 0; margin-bottom: 1rem; }
    .messages li { padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; }
    .messages li.success { background-color: #e8f5e9; color: #2e7d32; }
    .messages li.error { background-color: #ffebee; color: #c62828; }
    .file-block { margin-top: .5rem; }
    .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: .35rem; margin-top: .5rem; font-size: .9rem; }
    .meta-grid span { background: #f4f4f8; padding: .4rem .6rem; border-radius: 6px; display: inline-block; }
  </style>
</head>
<body>
  <p><a href="{% url 'project_list' %}">&larr; Retour aux projets</a></p>
  <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
      <h1>{{ project.name }} — Phase 1 : Datasets</h1>
      <div class="btn-group">
          <a href="{% url 'datasets' %}" class="btn" style="text-decoration: none; background: #455a64;">Gérer les datasets</a>
          <a href="{% url 'project_analysis_page' project.id %}" class="btn" style="text-decoration: none;">Analyser le projet &rarr;</a>
          <a href="{% url 'project_stage2' project.id %}" class="btn" style="text-decoration: none; background: #3949ab;">Stage2 – Partage &rarr;</a>
          <a href="{% url 'project_stage3' project.id %}" class="btn" style="text-decoration: none; background: #0d47a1;">Stage3 – Communauté &rarr;</a>
      </div>
  </div>

  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li class="{{ message.tags }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <div class="grid">
    <div class="card">
      <h2>Ajouter un membre</h2>
      <form method="post" action="{% url 'member_create' project.id %}">
        {% csrf_token %}
        <label>Nom</label>
        <input class="input" type="text" name="name" required>

        <label>Utilité (optionnel)</label>
        <input class="input" type="text" name="utility" placeholder="Bureau, magasin, serveur…">

        <label>Dataset</label>
        <select name="dataset" class="input" required>
          <option value="" disabled selected>Choisissez un dataset</option>
          {% for dataset in datasets %}
            <option value="{{ dataset.id }}">{{ dataset.name }}</option>
          {% endfor %}
        </select>
        <p class="muted">Chaque membre pointe vers un dataset normalisé (index mois/semaine/jour/quarter).</p>

        <label>Total conso. annuelle (kWh) – optionnel</label>
        <input class="input" step="0.01" min="0" type="number" name="annual_consumption_kwh" placeholder="Auto rempli si vide">

        <label>Total prod. annuelle (kWh) – optionnel</label>
        <input class="input" step="0.01" min="0" type="number" name="annual_production_kwh" placeholder="Auto rempli si vide">

        <label style="margin-top:1rem;">Tags existants</label>
        <select class="input" name="tags" multiple size="5">
          {% for tag in all_tags %}
            <option value="{{ tag.id }}">{{ tag.name }}</option>
          {% empty %}
            <option disabled>Aucun tag</option>
          {% endfor %}
        </select>

        <label>Créer des tags (séparés par des virgules)</label>
        <input class="input" type="text" name="new_tags" placeholder="habitation, prosumer">

        <button class="btn" type="submit" style="margin-top:1.5rem; width: 100%;">Créer le membre</button>
      </form>
    </div>

    <div class="card">
      <h2>Membres du projet</h2>
      <form method="get" action="" style="margin-bottom:.5rem; display:flex; flex-direction:column; gap:.35rem;">
        <label>Filtrer par tags</label>
        <select class="input" name="tags" multiple size="4">
          {% for tag in all_tags %}
            <option value="{{ tag.name }}" {% if tag.name in selected_tags %}selected{% endif %}>{{ tag.name }}</option>
          {% empty %}
            <option disabled>Aucun tag</option>
          {% endfor %}
        </select>
        <div style="display:flex; gap:.5rem; align-items:center;">
          <button class="btn" type="submit">Appliquer le filtre</button>
          {% if selected_tags %}<a href="?" class="muted" style="text-decoration:none;">Réinitialiser</a>{% endif %}
        </div>
      </form>
      <table>
        <thead>
          <tr><th>Nom</th><th>Dataset</th></tr>
        </thead>
        <tbody>
          {% for m in members %}
            <tr>
              <td>
                <strong>{{ m.name }}</strong><br>
                {% if m.utility %}<span class="muted">{{ m.utility }}</span>{% endif %}
                {% with m.tags.all as member_tags %}
                  {% if member_tags|length %}
                    <div style="margin-top:.25rem;">
                      {% for tag in member_tags %}
                        <span style="display:inline-block;background: {{ tag.color }}; color: #0d47a1; padding:0.2rem 0.55rem; border-radius:8px; margin-right:0.25rem; font-weight:600;">{{ tag.name }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endwith %}
              </td>
              <td>
                {% if m.dataset %}
                  <div class="file-block">
                    <strong>{{ m.dataset.name }}</strong>
                    {% if m.dataset.normalized_file %}
                      <div><a href="{{ m.dataset.normalized_file.url }}">Excel normalisé</a></div>
                    {% endif %}
                    {% if m.dataset.metadata %}
                      <div class="meta-grid">
                        <span><strong>Lignes :</strong> {{ m.dataset.metadata.row_count }}</span>
                        <span><strong>Consommation :</strong> {{ m.dataset.metadata.totals.consumption_kwh|floatformat:0 }} kWh</span>
                        <span><strong>Production :</strong> {{ m.dataset.metadata.totals.production_kwh|floatformat:0 }} kWh</span>
                        <span><strong>Granularité :</strong> {% if m.dataset.metadata.granularity_minutes %}{{ m.dataset.metadata.granularity_minutes|floatformat:0 }} min{% else %}—{% endif %}</span>
                      </div>
                    {% with m.dataset.tags.all as ds_tags %}
                      {% if ds_tags|length %}
                        <div style="margin-top:.35rem;">
                          {% for tag in ds_tags %}
                            <span style="display:inline-block;background: {{ tag.color }}; color: #0d47a1; padding:0.2rem 0.55rem; border-radius:8px; margin-right:0.25rem; font-weight:600;">{{ tag.name }}</span>
                          {% endfor %}
                        </div>
                      {% endif %}
                    {% endwith %}
                    {% else %}
                      <span class="muted">Métadonnées indisponibles.</span>
                    {% endif %}
                  </div>
                {% else %}
                  <span class="muted">Aucun dataset</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="2" class="muted" style="text-align: center; padding: 2rem;">Aucun membre pour l’instant.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</body>
</html>
