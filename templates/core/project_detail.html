<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>{{ project.name }} – Phase 1 : Ingestion</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; max-width: 1200px; background-color: #f9f9f9; }
    .grid { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; align-items: start; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem; background-color: #fff; }
    .input, select { padding: .75rem; border: 1px solid #ccc; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 1rem; margin-bottom: 0.5rem; }
    select[multiple] { height: 120px; }
    .btn { padding: .75rem 1.25rem; border-radius: 8px; border: none; background: #222; color: #fff; cursor: pointer; font-size: 1rem; }
    .btn-group { display: flex; gap: .75rem; flex-wrap: wrap; }
    table { width:100%; border-collapse: collapse; font-size: 1.05rem; }
    th, td { border-bottom: 1px solid #eee; padding: 1rem .5rem; text-align: left; vertical-align: top; }
    th { font-weight: 600; color: #555; }
    .muted { color: #666; font-size: .9rem; }
    .messages { list-style: none; padding: 0; margin-bottom: 1rem; }
    .messages li { padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; }
    .messages li.success { background-color: #e8f5e9; color: #2e7d32; }
    .messages li.error { background-color: #ffebee; color: #c62828; }
    .file-block { margin-top: .5rem; }
    .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: .35rem; margin-top: .5rem; font-size: .9rem; }
    .meta-grid span { background: #f4f4f8; padding: .4rem .6rem; border-radius: 6px; display: inline-block; }
  </style>
</head>
<body>
  <p><a href="{% url 'project_list' %}">&larr; Retour aux projets</a></p>
  <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
      <h1>{{ project.name }} — Phase 1 : Ingestion</h1>
      <div class="btn-group">
          <a href="{% url 'project_analysis_page' project.id %}" class="btn" style="text-decoration: none;">Analyser le projet &rarr;</a>
          <a href="{% url 'project_stage2' project.id %}" class="btn" style="text-decoration: none; background: #3949ab;">Stage 2 – Partage &rarr;</a>
          <a href="{% url 'project_stage3' project.id %}" class="btn" style="text-decoration: none; background: #0d47a1;">Stage 3 – Communauté &rarr;</a>
      </div>
  </div>

  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li class="{{ message.tags }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <div class="grid">
    <div class="card">
      <h2>Ajouter un membre</h2>
      <form method="post" action="{% url 'member_create' project.id %}" enctype="multipart/form-data">
        {% csrf_token %}
        <label>Nom</label>
        <input class="input" type="text" name="name" required>

        <label>Utilité (optionnel)</label>
        <input class="input" type="text" name="utility" placeholder="Bureau, magasin, serveur…">

        <label>Mode de données</label>
        <select name="data_mode" class="input" id="data_mode">
          <option value="timeseries_csv">Série 15-min via CSV</option>
          <option value="profile_based">Basé sur profil(s) & total annuel</option>
        </select>

        <div id="csv_fields">
          <label>Fichier de données (CSV ou Excel, quart d'heure)</label>
          <input class="input" type="file" name="timeseries_file" accept=".csv,.xls,.xlsx">
          <p class="muted">Colonnes détectées automatiquement (horodatage + énergie). Un résumé vous sera affiché après import.</p>

          <label>Ou choisir un modèle converti</label>
          <select name="ingestion_template_id" class="input">
            <option value="">— Modèle enregistré —</option>
            {% for template in ingestion_templates %}
              <option value="{{ template.id }}">{{ template.name }}{% if template.tags %} — {{ template.tags }}{% endif %}{% if template.metadata %} ({{ template.metadata.row_count|default:template.row_count }} lignes){% endif %}</option>
            {% endfor %}
          </select>
          <p class="muted">Les modèles viennent de la page « Modèle d'import ». Le fichier sélectionné sera attaché au membre.</p>
        </div>

        <div id="profile_fields" style="display:none">
          <label>Profils (maintenir Ctrl/Cmd pour sélectionner plusieurs)</label>
          <select name="profiles" class="input" multiple>
              {% for p in profiles %}
                <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
          </select>

          <label>Total conso. annuelle (kWh)</label>
          <input class="input" step="0.01" min="0" type="number" name="annual_consumption_kwh" placeholder="Ex: 50000">

          <label>Total prod. annuelle (kWh)</label>
          <input class="input" step="0.01" min="0" type="number" name="annual_production_kwh" placeholder="Ex: 12000">
        </div>

        <h3 style="margin-top:1.5rem;">Données économiques (Stage 3)</h3>

        <label>Prix actuel de l'énergie (€/kWh)</label>
        <input class="input" type="number" step="0.001" min="0" name="current_unit_price_eur_per_kwh" value="0.25">

        <label>Frais fixes annuels actuels (€)</label>
        <input class="input" type="number" step="0.01" min="0" name="current_fixed_fee_eur" value="0.00">

        <label>Énergie injectée annuellement (kWh)</label>
        <input class="input" type="number" step="0.01" min="0" name="injection_annual_kwh" value="0.00">

        <label>Tarif d'injection (€/kWh)</label>
        <input class="input" type="number" step="0.001" min="0" name="injection_unit_price_eur_per_kwh" value="0.05">

        <button class="btn" type="submit" style="margin-top:1.5rem; width: 100%;">Créer le membre</button>
      </form>
    </div>

    <div class="card">
      <h2>Membres du projet</h2>
      <table>
        <thead>
          <tr><th>Nom</th><th>Détails du fichier</th></tr>
        </thead>
        <tbody>
          {% for m in members %}
            <tr>
              <td>
                <strong>{{ m.name }}</strong><br>
                {% if m.utility %}<span class="muted">{{ m.utility }}</span>{% endif %}
              </td>
              <td>
                {% if m.timeseries_file %}
                  <div class="file-block">
                    <a href="{{ m.timeseries_file.url }}">Télécharger le fichier</a>
                    {% if m.timeseries_metadata %}
                      <div class="meta-grid">
                        <span><strong>Lignes :</strong> {{ m.timeseries_metadata.row_count }}</span>
                        <span><strong>Début :</strong> {{ m.timeseries_metadata.start|default:"—"|slice:":16" }}</span>
                        <span><strong>Fin :</strong> {{ m.timeseries_metadata.end|default:"—"|slice:":16" }}</span>
                        <span><strong>Granularité :</strong> {% if m.timeseries_metadata.granularity_minutes %}{{ m.timeseries_metadata.granularity_minutes|floatformat:0 }} min{% else %}—{% endif %}</span>
                        <span><strong>Consommation :</strong> {{ m.timeseries_metadata.totals.consumption_kwh|floatformat:0 }} kWh</span>
                        <span><strong>Production :</strong> {{ m.timeseries_metadata.totals.production_kwh|floatformat:0 }} kWh</span>
                      </div>
                      {% if m.timeseries_metadata.warnings %}
                        <ul class="muted" style="margin-top:.5rem; padding-left:1.2rem;">
                          {% for warning in m.timeseries_metadata.warnings %}
                            <li>{{ warning }}</li>
                          {% endfor %}
                        </ul>
                      {% endif %}
                    {% else %}
                      <span class="muted">Métadonnées indisponibles.</span>
                    {% endif %}
                  </div>
                {% else %}
                  <span class="muted">Aucun fichier</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="2" class="muted" style="text-align: center; padding: 2rem;">Aucun membre pour l’instant.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const modeSel = document.getElementById('data_mode');
    const csvFields = document.getElementById('csv_fields');
    const profFields = document.getElementById('profile_fields');
    function toggle() {
      if (modeSel.value === 'profile_based') {
        profFields.style.display = 'block';
        csvFields.style.display = 'none';
        csvFields.querySelector('input').required = false;
      } else {
        profFields.style.display = 'none';
        csvFields.style.display = 'block';
        csvFields.querySelector('input').required = true;
      }
    }
    modeSel.addEventListener('change', toggle);
    toggle();
  </script>
</body>
</html>