{% extends "core/base.html" %}

{% block title %}Datasets – Yes-Partner{% endblock %}

{% block content %}
  <style>
    .dataset-page { display: grid; grid-template-columns: minmax(0, 1.6fr) minmax(320px, 1fr); gap: 1.5rem; align-items: start; }
    .dataset-list { display: flex; flex-direction: column; gap: .9rem; margin-top: .75rem; }
    .dataset-row { display: grid; grid-template-columns: 1fr auto; gap: 1rem; padding: 1rem; border: 1px solid var(--border); border-radius: 12px; background: #fff; }
    .dataset-row:hover { box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08); }
    .tag-grid { display: flex; flex-wrap: wrap; gap: .35rem; }
    .filter-tags { display: flex; flex-wrap: wrap; gap: .35rem; margin-top: .4rem; }
    .tag-chip { display: inline-flex; align-items: center; gap: .35rem; padding: .3rem .65rem; border-radius: 999px; border: 1px solid var(--border); background: #eef2ff; color: #111827; font-weight: 600; }
    .tag-chip strong { display: inline-block; min-width: 18px; height: 18px; border-radius: 999px; }
    .tag-chip button { border: none; background: transparent; cursor: pointer; font-size: 1rem; color: #475569; }
    .tag-chip button:hover { color: #0f172a; }
    .tag-input-row { display: flex; flex-wrap: wrap; align-items: center; gap: .5rem; }
    .badge-row { display: flex; gap: .5rem; flex-wrap: wrap; margin-top: .5rem; }
    .badge { padding: .35rem .65rem; border-radius: 10px; background: #eef2ff; color: #4338ca; font-weight: 600; font-size: .95rem; }
    .upload-box { border: 1px dashed var(--border); padding: 1rem; border-radius: 12px; background: #f8fafc; }
    .messages { list-style: none; padding: 0; margin: 0 0 1rem 0; }
    .messages li { padding: .8rem 1rem; border-radius: 10px; margin-bottom: .5rem; font-weight: 600; }
    .messages li.success { background: #ecfdf3; color: #065f46; }
    .messages li.error { background: #fef2f2; color: #b91c1c; }
    .messages li.warning { background: #fff7ed; color: #c2410c; }
  </style>

  <div class="stack">
    {% if messages %}
      <ul class="messages">
        {% for message in messages %}
          <li class="{{ message.tags }}">{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    <div class="dataset-page">
      <div class="card">
        <div class="stack" style="gap: .6rem;">
          <div class="pill" style="width: fit-content;">Phase 1 • Bibliothèque</div>
          <h1 style="margin: 0;">Datasets & tags</h1>
          <p class="muted" style="margin: 0; max-width: 720px;">Ajoutez vos séries, créez des tags colorés directement depuis le dataset et filtrez la liste par mots-clés ou par tags multiples.</p>
          <div class="badge-row">
            <span class="badge">{{ datasets|length }} datasets</span>
            <span class="badge">{{ all_tags|length }} tags</span>
          </div>
        </div>

        <div class="card" style="margin-top: 1.25rem;">
          <div style="display:flex; justify-content: space-between; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <div>
              <h3 style="margin: 0;">Recherche & filtres</h3>
              <p class="muted" style="margin: .2rem 0 0 0;">Recherchez par nom ou par tags. Les filtres s'empilent pour ressembler à une vue Notion.</p>
            </div>
            {% if selected_tags %}<a href="?" class="muted" style="text-decoration:none; font-weight: 600;">Réinitialiser</a>{% endif %}
          </div>
          <form method="get" action="{% url 'datasets' %}" class="stack" id="dataset-filter-form">
            <input class="input" type="search" name="q" value="{{ query }}" placeholder="Rechercher un dataset ou un tag…">
            <div class="stack" style="gap:.35rem;">
              <label class="muted" style="font-weight:600;">Tags (tapez pour filtrer puis validez avec Entrée)</label>
              <div class="tag-input-row">
                <input class="input" list="all-dataset-tags" id="tag-search" placeholder="Ajouter un tag…">
                <button class="btn secondary" type="button" id="clear-tags" aria-label="Réinitialiser les tags">✕ Effacer</button>
              </div>
              <datalist id="all-dataset-tags">
                {% for tag in all_tags %}
                  <option value="{{ tag.name }}"></option>
                {% endfor %}
              </datalist>
              <div class="filter-tags" id="selected-tags">
                {% for tag_name in selected_tags %}
                  <span class="tag-chip" data-tag="{{ tag_name }}">
                    <strong style="background: #4338ca;"></strong>
                    <span>{{ tag_name }}</span>
                    <button type="button" aria-label="Supprimer {{ tag_name }}">×</button>
                    <input type="hidden" name="tags" value="{{ tag_name }}">
                  </span>
                {% endfor %}
                {% if not selected_tags %}
                  <span class="muted" id="no-tags">Aucun tag sélectionné.</span>
                {% endif %}
              </div>
            </div>
            <div style="display:flex; gap:.6rem; align-items:center; flex-wrap: wrap;">
              <button class="btn" type="submit">Filtrer</button>
              {% if selected_tags or query %}<span class="muted">{{ datasets|length }} résultat{{ datasets|length|pluralize:"s"}}</span>{% endif %}
            </div>
          </form>
        </div>

        <div class="card" style="margin-top: 1.25rem;">
          <div style="display:flex; justify-content: space-between; align-items: center; gap: 1rem;">
            <h3 style="margin: 0;">Datasets</h3>
            <span class="muted">Chaque ligne affiche les métadonnées clés et les tags colorés.</span>
          </div>
          <div class="dataset-list">
            {% for dataset in datasets %}
              <div class="dataset-row">
                <div>
                  <div style="display:flex; align-items:center; gap:.5rem; flex-wrap:wrap;">
                    <strong style="font-size: 1.05rem;">{{ dataset.name }}</strong>
                    {% with dataset.tags.all as ds_tags %}
                      {% for tag in ds_tags %}
                        <span class="chip" style="background: {{ tag.color }}33; border: 1px solid {{ tag.color }};">{{ tag.name }}</span>
                      {% empty %}
                        <span class="muted">Pas de tag</span>
                      {% endfor %}
                    {% endwith %}
                  </div>
                  {% if dataset.metadata %}
                    <div class="meta-grid" style="margin-top:.4rem;">
                      <span><strong>Lignes :</strong> {{ dataset.metadata.row_count }}</span>
                      <span><strong>Conso :</strong> {{ dataset.metadata.totals.consumption_kwh|floatformat:1 }} kWh</span>
                      <span><strong>Prod :</strong> {{ dataset.metadata.totals.production_kwh|floatformat:1 }} kWh</span>
                      <span><strong>Granularité :</strong> {% if dataset.metadata.granularity_minutes %}{{ dataset.metadata.granularity_minutes|floatformat:0 }} min{% else %}—{% endif %}</span>
                    </div>
                  {% else %}
                    <p class="muted" style="margin:.35rem 0 0;">Métadonnées indisponibles.</p>
                  {% endif %}
                </div>
                <div style="text-align:right; display:flex; flex-direction:column; gap:.35rem; justify-content:center;">
                  {% if dataset.normalized_file %}
                    <a href="{{ dataset.normalized_file.url }}" class="btn secondary" style="text-decoration:none;">Excel normalisé</a>
                  {% else %}
                    <span class="muted">Fichier normalisé manquant</span>
                  {% endif %}
                </div>
              </div>
            {% empty %}
              <div class="dataset-row">
                <div><strong>Aucun dataset pour l’instant.</strong><p class="muted" style="margin:.25rem 0 0;">Importez votre premier fichier pour lancer la bibliothèque.</p></div>
                <div></div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="card" style="position: sticky; top: 88px;">
        <h3 style="margin-top:0;">Nouveau dataset</h3>
        <p class="muted" style="margin-top:.15rem;">Créez les tags directement ici, ils seront réutilisables pour les projets et les filtres.</p>
        <form method="post" action="{% url 'dataset_create' %}" enctype="multipart/form-data" class="stack">
          {% csrf_token %}
          <div>
            <label>Nom</label>
            <input class="input" type="text" name="name" placeholder="Bâtiment A – 2024" required>
          </div>

          <div>
            <label>Tags existants</label>
            <div class="filter-tags">
              {% for tag in all_tags %}
                <label class="tag-pill">
                  <input type="checkbox" name="tags" value="{{ tag.id }}">
                  <span class="chip" style="background: {{ tag.color }}33; border: 1px solid {{ tag.color }};">{{ tag.name }}</span>
                </label>
              {% empty %}
                <span class="muted">Aucun tag pour le moment.</span>
              {% endfor %}
            </div>
          </div>

          <div>
            <label>Créer des tags (séparés par des virgules)</label>
            <input class="input" type="text" name="new_tags" placeholder="solaire, bureau, 2023">
          </div>

          <div class="upload-box">
            <label>Fichier (CSV ou Excel)</label>
            <input class="input" type="file" name="source_file" accept=".csv,.xls,.xlsx" required>
            <p class="muted" style="margin:.4rem 0 0;">Le fichier est indexé automatiquement par mois, semaine, jour et quart d'heure.</p>
          </div>

          <button class="btn" type="submit">Importer le dataset</button>
        </form>
      </div>
    </div>
  </div>
  <script>
    (function() {
      const input = document.getElementById('tag-search');
      const selectedContainer = document.getElementById('selected-tags');
      const clearBtn = document.getElementById('clear-tags');
      const emptyState = document.getElementById('no-tags');

      function showEmpty(show) {
        if (!emptyState) { return; }
        emptyState.style.display = show ? 'inline' : 'none';
      }

      function addHidden(tagName) {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'tags';
        hidden.value = tagName;
        return hidden;
      }

      function addTag(tagName) {
        if (!tagName) return;
        const existing = selectedContainer.querySelector(`[data-tag="${CSS.escape(tagName)}"]`);
        if (existing) { input.value = ''; return; }
        const chip = document.createElement('span');
        chip.className = 'tag-chip';
        chip.dataset.tag = tagName;
        chip.innerHTML = `<strong></strong><span>${tagName}</span><button type="button" aria-label="Supprimer ${tagName}">×</button>`;
        chip.querySelector('strong').style.background = '#4338ca';
        chip.appendChild(addHidden(tagName));
        selectedContainer.appendChild(chip);
        chip.querySelector('button').addEventListener('click', () => removeTag(tagName));
        showEmpty(false);
        input.value = '';
      }

      function removeTag(tagName) {
        const chip = selectedContainer.querySelector(`[data-tag="${CSS.escape(tagName)}"]`);
        if (chip) {
          chip.remove();
        }
        if (!selectedContainer.querySelector('.tag-chip')) {
          showEmpty(true);
        }
      }

      input?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addTag(input.value.trim());
        }
      });

      clearBtn?.addEventListener('click', () => {
        selectedContainer.querySelectorAll('.tag-chip').forEach((chip) => chip.remove());
        showEmpty(true);
        input.value = '';
      });

      selectedContainer?.querySelectorAll('.tag-chip button').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          const tagName = e.target.closest('.tag-chip')?.dataset.tag;
          if (tagName) removeTag(tagName);
        });
      });
    })();
  </script>
{% endblock %}
